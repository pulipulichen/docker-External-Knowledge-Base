events {
    worker_connections 1024;
}

http {
    server_tokens off; # 隱藏 Nginx 版本號

    # ========================================================
    # --- [全域限制定義] ---
    # ========================================================
    
    # 1) 一般 API / 網頁請求：每秒 10 次請求
    limit_req_zone $binary_remote_addr zone=api_general:10m rate=10r/s;

    # 2) 敏感 MCP 介面或 API：每秒 2 次請求（較嚴格）
    limit_req_zone $binary_remote_addr zone=api_strict:10m rate=2r/s;

    # 3) 連線數限制：限制單一 IP 同時連線數
    limit_conn_zone $binary_remote_addr zone=addr_conn:10m;

    # ========================================================
    # --- [惡意/不需要的爬蟲 UA 黑名單] ---
    # ========================================================
    map $http_user_agent $block_bot {
        default 0;
        ~*SemrushBot  1;
        ~*AhrefsBot   1;
        ~*MJ12bot     1;
        ~*DotBot      1;
        ~*PetalBot    1;
        ~*YisouSpider 1;
        ~*Bytespider  1;
        ~*GPTBot      1;
        ~*ClaudeBot   1;
        ~*CCBot       1;
        ~*FacebookBot 1;
        ~*Go-http-client   1;
        ~*Python-urllib    1;
        ~*python-requests  1;
        ~*Scrapy           1;
        ~*Java/            1;
        ~*wget             1;
    }

    server {
        listen 80;
        server_name localhost;

        # ========================================================
        # --- [真實 IP 解析] ---
        # ========================================================
        # 如果前面有 Nginx Proxy Manager (NPM) 或 Cloudflare，
        # 請將其 IP 網段加入此處。範例為信任 192.168.50.1
        set_real_ip_from 192.168.50.0/24;
        real_ip_header X-Forwarded-For;
        real_ip_recursive on;

        # ========================================================
        # --- [基礎安全過濾] ---
        # ========================================================
        
        # 阻擋空 User-Agent
        if ($http_user_agent ~ ^$) {
            return 403;
        }

        # 阻擋黑名單中的爬蟲
        if ($block_bot) {
            return 403;
        }

        # 限制單一 IP 同時連線數最多 30 個
        limit_conn addr_conn 30;
        limit_conn_status 429;

        # 關閉 404 錯誤記錄與存取記錄（節省 I/O）
        log_not_found off;
        access_log off;

        # ========================================================
        # --- [路由處理] ---
        # ========================================================

        # MCP 服務：套用較嚴格的限流 (Strict)
        location /mcp {
            limit_req zone=api_strict burst=10 nodelay;

            proxy_pass http://mcp_server/mcp;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 隱藏後端伺服器資訊
            proxy_hide_header X-Powered-By;
            proxy_hide_header Server;
        }
        
        # 一般 API：套用普通限流 (General)
        location / {
            limit_req zone=api_general burst=20 nodelay;

            proxy_pass http://api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 隱藏後端伺服器資訊
            proxy_hide_header X-Powered-By;
            proxy_hide_header Server;
        }

        # 禁止存取隱藏檔案 (如 .env, .git)
        location ~ /\. {
            deny all;
        }
    }
}